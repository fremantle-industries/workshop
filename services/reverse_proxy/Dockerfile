FROM nginx:1.23.2-alpine
# default environment configuration that can be overridden at run time
ENV WORKSHOP_UI_EXTERNAL_HOST=${WORKSHOP_UI_EXTERNAL_HOST:-workshop.localhost}
ENV WORKSHOP_UI_INTERNAL_HOST=${WORKSHOP_UI_INTERNAL_HOST:-workshop-ui}
ENV WORKSHOP_UI_HTTP_PORT=${WORKSHOP_UI_HTTP_PORT:-8080}
ENV WORKSHOP_API_EXTERNAL_HOST=${WORKSHOP_API_EXTERNAL_HOST:-api.localhost}
ENV WORKSHOP_API_INTERNAL_HOST=${WORKSHOP_API_INTERNAL_HOST:-workshop-api}
ENV WORKSHOP_API_HTTP_PORT=${WORKSHOP_API_HTTP_PORT:-8081}
ENV REDPANDA_CONSOLE_EXTERNAL_HOST=${REDPANDA_CONSOLE_EXTERNAL_HOST:-redpanda.localhost}
ENV REDPANDA_CONSOLE_INTERNAL_HOST=${REDPANDA_CONSOLE_INTERNAL_HOST:-redpanda-console}
ENV REDPANDA_CONSOLE_HTTP_PORT=${REDPANDA_CONSOLE_HTTP_PORT:-8080}
ENV REVERSE_PROXY_HTTP_PORT=${REVERSE_PROXY_HTTP_PORT:-8080}
ENV REVERSE_PROXY_DNS_RESOLVER_ADDRESS=${REVERSE_PROXY_DNS_RESOLVER_ADDRESS:-127.0.0.11}

COPY ./templates/nginx.conf /etc/nginx/templates/nginx.conf

RUN apk add --update apache2-utils

CMD sh -c 'envsubst "\
      \${WORKSHOP_UI_EXTERNAL_HOST} \
      \${WORKSHOP_UI_INTERNAL_HOST} \
      \${WORKSHOP_UI_HTTP_PORT} \
      \${WORKSHOP_API_EXTERNAL_HOST} \
      \${WORKSHOP_API_INTERNAL_HOST} \
      \${WORKSHOP_API_HTTP_PORT} \
      \${REDPANDA_CONSOLE_EXTERNAL_HOST} \
      \${REDPANDA_CONSOLE_INTERNAL_HOST} \
      \${REDPANDA_CONSOLE_HTTP_PORT} \
      \${REVERSE_PROXY_HTTP_PORT} \
      \${REVERSE_PROXY_DNS_RESOLVER_ADDRESS}" \
    < /etc/nginx/templates/nginx.conf \
    > /etc/nginx/nginx.conf \
    && nginx -g "daemon off;"'
